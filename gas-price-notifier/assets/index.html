<!doctype html>

<html>

<head>
    <title>gasz : Etereum Gas Price Notifier</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="author" content="Anjan Roy">
    <meta name="description"
        content="ette : Ethereum Blockchain Data Indexing Engine, with historical data query & real-time notification support">
    <meta name="theme-color" content="#667799">
    <link rel="stylesheet" type="text/css" href="semantic.min.css">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"
        integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="semantic.min.js"></script>
</head>

<body style="background: linear-gradient(to right, #669999 0%, #666699 100%);">
    <div class="ui center aligned container">
        <form class="ui form">
            <div class="ui raised very padded text inverted container segment">
                <h2 class="ui header">Ethereum Gas Price Notification</h2>
            </div>

            <div class="field">
                <label>Transaction Speed :</label>
                <div class="ui search selection dropdown">
                    <input type="hidden" name="txSpeed">
                    <i class="dropdown icon"></i>
                    <div class="default text">Fast</div>
                    <div class="menu">
                        <div class="item" data-value="fast">Fast</div>
                        <div class="item" data-value="fastest">Fastest</div>
                        <div class="item" data-value="safeLow">Safe Low</div>
                        <div class="item" data-value="average">Average</div>
                    </div>
                </div>
            </div>

            <div class="field">
                <label>Gas Price ( in Gwei ) :</label>
                <div class="two fields">
                    <div class="field">
                        <div class="ui search selection dropdown">
                            <input type="hidden" name="operator">
                            <i class="dropdown icon"></i>
                            <div class="default text"><</div>
                            <div class="menu">
                                <div class="item" data-value="<"><</div>
                                <div class="item" data-value="<="><=</div>
                                <div class="item" data-value=">">></div>
                                <div class="item" data-value=">=">>=</div>
                                <div class="item" data-value="==">==</div>
                            </div>
                        </div>    
                    </div>
                    <div class="field">
                        <input type="number" min="1" name="gasPrice" placeholder="30">
                    </div>
                </div>
            </div>

            <div class="ui submit button olive" tabindex="0" onclick="{

                const createSubscription = payload => {

                    if (typeof GASZ_SOCKET !== 'undefined') {
                    
                        GASZ_SOCKET.send(JSON.stringify(payload))

                        GASZ_SOCKET.onmessage = e => {
                            const msg = JSON.parse(e.data)
                    
                            if ('code' in msg){
                                if(msg['code'] !== 1) {

                                    $('form').form('clear')
                                    alert(`${msg['message']}`)
                                    return

                                }
                        
                                $('form').form('clear')
                                $('.page.dimmer:first').dimmer('toggle')
                                return
                            }

                            if (Notification.permission === 'granted') {
                                const notify = new Notification('Gasz ⚡️', {body: `${msg}`, icon: `http://${window.location.host}/gasz.png`})
                                
                                notify.onclick = e => {
                                    if (typeof GASZ_SOCKET !== 'undefined') {
                                        GASZ_SOCKET.send(JSON.stringify({...payload, type: 'unsubscription'}))
                                    }
                                }
                            }

                            console.log(msg)
                        }

                    } else {
                        alert('Failed to connect to server !')
                    }

                }

                const form = $('form')

                const txSpeed = form.form('get value', 'txSpeed')
                const operator = form.form('get value', 'operator')
                const gasPrice = form.form('get value', 'gasPrice')

                if (txSpeed === '' || operator === '' || gasPrice === '') {
                    return
                }

                if (Notification.permission !== 'granted') {
                    Notification.requestPermission().then(p => {
                        if(p !== 'granted') {
                            alert('Can\'t work without Notification !')
                            return
                        } else {
                            createSubscription({
                                type: 'subscription',
                                field: txSpeed,
                                operator,
                                threshold: parseFloat(gasPrice)
                            })
                        }
                    })
                } else {
                    createSubscription({
                        type: 'subscription',
                        field: txSpeed,
                        operator,
                        threshold: parseFloat(gasPrice)
                    })
                }

            }">
                Add Gas Price Subscription
            </div>
        </form>
    </div>
    <div class="ui page dimmer">
        <div class="content">
            <h2 class="ui inverted icon header">
                <i class="thumbs up icon"></i>
                Gas Price Subscription created
            </h2>
        </div>
    </div>
    <script>
        const setup = _ => {
            if (!('Notification' in window)) {
                alert('Browser doesn\'t support Notification 🙂')
                return
            }

        if (Notification.permission !== 'granted') {
            Notification.requestPermission().then(p => {
                if(p !== 'granted') {
                    alert('Can\'t work without Notification !')
                    return
                }
            })
        }

        if (typeof GASZ_SOCKET === 'undefined') {
            const socket = new WebSocket(`ws://${window.location.host}/v1/subscribe`)

            socket.onopen = e => {
                console.log('Connection Opened')
                window.GASZ_SOCKET = socket
            }

            socket.onclose = e => {
                console.log('Connection Closed')
                window.GASZ_SOCKET = null
            }

            socket.onerror = e => {
                console.log('Error in connection')
                window.GASZ_SOCKET = null
            }
        }

        $('.ui.dropdown').dropdown()
        }
        console.log()
        setup()
    </script>
</body>

</html>
